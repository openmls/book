<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Traits - OpenMLS Book</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded "><a href="../user_manual/index.html"><strong aria-hidden="true">1.</strong> User manual</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../user_manual/identity.html"><strong aria-hidden="true">1.1.</strong> Credentials</a></li><li class="chapter-item expanded "><a href="../user_manual/create_key_package.html"><strong aria-hidden="true">1.2.</strong> Key packages</a></li><li class="chapter-item expanded "><a href="../user_manual/group_config.html"><strong aria-hidden="true">1.3.</strong> Group configuration</a></li><li class="chapter-item expanded "><a href="../user_manual/create_group.html"><strong aria-hidden="true">1.4.</strong> Creating groups</a></li><li class="chapter-item expanded "><a href="../user_manual/join_from_welcome.html"><strong aria-hidden="true">1.5.</strong> Join a group from a Welcome message</a></li><li class="chapter-item expanded "><a href="../user_manual/join_from_external_commit.html"><strong aria-hidden="true">1.6.</strong> Join a group from an External Commit message</a></li><li class="chapter-item expanded "><a href="../user_manual/add_members.html"><strong aria-hidden="true">1.7.</strong> Adding members to a group</a></li><li class="chapter-item expanded "><a href="../user_manual/remove_members.html"><strong aria-hidden="true">1.8.</strong> Removing members from a group</a></li><li class="chapter-item expanded "><a href="../user_manual/updates.html"><strong aria-hidden="true">1.9.</strong> Updating own key package</a></li><li class="chapter-item expanded "><a href="../user_manual/aad.html"><strong aria-hidden="true">1.10.</strong> Using Additional Authenticated Data (AAD)</a></li><li class="chapter-item expanded "><a href="../user_manual/leaving.html"><strong aria-hidden="true">1.11.</strong> Leaving a group</a></li><li class="chapter-item expanded "><a href="../user_manual/custom_proposals.html"><strong aria-hidden="true">1.12.</strong> Custom proposals</a></li><li class="chapter-item expanded "><a href="../user_manual/application_messages.html"><strong aria-hidden="true">1.13.</strong> Creating application messages</a></li><li class="chapter-item expanded "><a href="../user_manual/commit_to_proposals.html"><strong aria-hidden="true">1.14.</strong> Committing to pending proposals</a></li><li class="chapter-item expanded "><a href="../user_manual/processing.html"><strong aria-hidden="true">1.15.</strong> Processing incoming messages</a></li><li class="chapter-item expanded "><a href="../user_manual/persistence.html"><strong aria-hidden="true">1.16.</strong> Persistence of group state</a></li><li class="chapter-item expanded "><a href="../user_manual/credential_validation.html"><strong aria-hidden="true">1.17.</strong> Credential validation</a></li><li class="chapter-item expanded "><a href="../user_manual/wasm.html"><strong aria-hidden="true">1.18.</strong> WebAssembly</a></li></ol></li><li class="chapter-item expanded "><a href="../traits/index.html"><strong aria-hidden="true">2.</strong> Traits & External Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../traits/traits.html" class="active"><strong aria-hidden="true">2.1.</strong> Traits</a></li><li class="chapter-item expanded "><a href="../traits/types.html"><strong aria-hidden="true">2.2.</strong> Types</a></li></ol></li><li class="chapter-item expanded "><a href="../message_validation.html"><strong aria-hidden="true">3.</strong> Message Validation</a></li><li class="chapter-item expanded "><a href="../app_validation.html"><strong aria-hidden="true">4.</strong> App Validation</a></li><li class="chapter-item expanded "><a href="../performance.html"><strong aria-hidden="true">5.</strong> Performance</a></li><li class="chapter-item expanded "><a href="../forward_secrecy.html"><strong aria-hidden="true">6.</strong> Forward Secrecy</a></li><li class="chapter-item expanded "><a href="../release_management.html"><strong aria-hidden="true">7.</strong> Release management</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OpenMLS Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="openmls-traits"><a class="header" href="#openmls-traits">OpenMLS Traits</a></h1>
<blockquote>
<p><strong>⚠️ These traits are responsible for all cryptographic operations and randomness
within OpenMLS.
Please ensure you know what you're doing when implementing your own versions.</strong></p>
</blockquote>
<p>Because implementing the <code>OpenMLSCryptoProvider</code> is challenging, requires
tremendous care, and is not what the average OpenMLS consumer wants to (or should)
do, we provide two implementations that can be used.</p>
<ul>
<li><a href="https://crates.io/crates/openmls_rust_crypto">Rust Crypto</a></li>
<li><a href="https://crates.io/crates/openmls_libcrux_crypto">Libcrux Crypto</a></li>
</ul>
<p><strong>Rust Crypto Provider</strong>
The go-to default at the moment is an implementation using commonly used, native
Rust crypto implementations.</p>
<p><strong>Libcrux Crypto Provider</strong>
A crypto provider backed by the high-assurance cryptography library [libcrux].
Currently only supports relatively modern x86 and amd64 CPUs, as it requires
AES-NI, SIMD and AVX.</p>
<h2 id="the-traits"><a class="header" href="#the-traits">The Traits</a></h2>
<p>There are 4 different traits defined in the <a href="https://crates.io/crates/openmls_traits">OpenMLS traits crate</a>.</p>
<h3 id="openmlsrand"><a class="header" href="#openmlsrand">OpenMlsRand</a></h3>
<p>This trait defines two functions to generate arrays and vectors, and is used by
OpenMLS to generate randomness for key generation and random identifiers.
While there is the commonly used <a href="https://crates.io/crates/rand">rand crate</a>, not all implementations use it.
OpenMLS, therefore, defines its own randomness trait that needs to be implemented
by an OpenMLS crypto provider.
It simply needs to implement two functions to generate cryptographically secure
randomness and store it in an array or vector.</p>
<pre><code class="language-rust no_run noplayground">pub trait OpenMlsRand {
    type Error: std::error::Error + Debug;

    /// Fill an array with random bytes.
    fn random_array&lt;const N: usize&gt;(&amp;self) -&gt; Result&lt;[u8; N], Self::Error&gt;;

    /// Fill a vector of length `len` with bytes.
    fn random_vec(&amp;self, len: usize) -&gt; Result&lt;Vec&lt;u8&gt;, Self::Error&gt;;
}</code></pre>
<h3 id="openmlscrypto"><a class="header" href="#openmlscrypto">OpenMlsCrypto</a></h3>
<p>This trait defines all cryptographic functions required by OpenMLS. In particular:</p>
<ul>
<li>HKDF</li>
<li>Hashing</li>
<li>AEAD</li>
<li>Signatures</li>
<li>HPKE</li>
</ul>
<h3 id="storageprovider"><a class="header" href="#storageprovider">StorageProvider</a></h3>
<p>This trait defines an API for a storage backend that is used for all OpenMLS
persistence.</p>
<p>The store provides functions for reading and updating stored values.
Each sort of value has separate methods for accessing or mutating the state.
In order to decouple the provider from the OpenMLS implementation, while still
having legible types at the provider, there are traits that mirror all the types
stored by OpenMLS. The provider methods use values constrained by these traits as
as arguments.</p>
<pre><code class="language-rust no_run noplayground">/// Each trait in this module corresponds to a type. Some are used as keys, some as
/// entities, and some both. Therefore, the Key and/or Entity traits also need to be implemented.
pub mod traits {
    use super::{Entity, Key};

    // traits for keys, one per data type
    pub trait GroupId&lt;const VERSION: u16&gt;: Key&lt;VERSION&gt; {}
    pub trait SignaturePublicKey&lt;const VERSION: u16&gt;: Key&lt;VERSION&gt; {}
    pub trait HashReference&lt;const VERSION: u16&gt;: Key&lt;VERSION&gt; {}
    pub trait PskId&lt;const VERSION: u16&gt;: Key&lt;VERSION&gt; {}
    pub trait EncryptionKey&lt;const VERSION: u16&gt;: Key&lt;VERSION&gt; {}
    pub trait EpochKey&lt;const VERSION: u16&gt;: Key&lt;VERSION&gt; {}

    // traits for entity, one per type
    pub trait QueuedProposal&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait TreeSync&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait GroupContext&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait InterimTranscriptHash&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait ConfirmationTag&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait SignatureKeyPair&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait PskBundle&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait HpkeKeyPair&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait GroupState&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait GroupEpochSecrets&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait LeafNodeIndex&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait MessageSecrets&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait ResumptionPskStore&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait KeyPackage&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait MlsGroupJoinConfig&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}
    pub trait LeafNode&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; {}

    // traits for types that implement both
    pub trait ProposalRef&lt;const VERSION: u16&gt;: Entity&lt;VERSION&gt; + Key&lt;VERSION&gt; {}
}</code></pre>
<p>The traits are generic over a <code>VERSION</code>, which is used to ensure that the values
that are persisted can be upgraded when OpenMLS changes the stored structs.</p>
<p>The traits used as arguments to the storage methods are constrained to implement
the <code>Key</code> or <code>Entity</code> traits as well, depending on whether they are only used for
addressing (in which case they are a <code>Key</code>) or whether they represent a stored
value (in which case they are an <code>Entity</code>).</p>
<pre><code class="language-rust no_run noplayground">/// Key is a trait implemented by all types that serve as a key (in the database sense) to in the
/// storage. For example, a GroupId is a key to the stored entities for the group with that id.
/// The point of a key is not to be stored, it's to address something that is stored.
pub trait Key&lt;const VERSION: u16&gt;: Serialize {}</code></pre>
<pre><code class="language-rust no_run noplayground">/// Entity is a trait implemented by the values being stored.
pub trait Entity&lt;const VERSION: u16&gt;: Serialize + DeserializeOwned {}</code></pre>
<p>An implementation of the storage trait should ensure that it can address and
efficiently handle values.</p>
<h4 id="example-key-packages"><a class="header" href="#example-key-packages">Example: Key packages</a></h4>
<p>This is only an example, but it illustrates that the application may need to do more
when it comes to implementing storage.</p>
<p>Key packages are only deleted by OpenMLS when they are used and <em>not</em> last resort
key packages (which may be used multiple times).
The application needs to implement some logic to manage last resort key packages.</p>
<pre><code class="language-rust no_run noplayground">    fn write_key_package&lt;
        HashReference: traits::HashReference&lt;VERSION&gt;,
        KeyPackage: traits::KeyPackage&lt;VERSION&gt;,
    &gt;(
        &amp;self,
        hash_ref: &amp;HashReference,
        key_package: &amp;KeyPackage,
    ) -&gt; Result&lt;(), Self::Error&gt;;</code></pre>
<p>The application may store the hash references in a separate list with a validity
period.</p>
<pre><code class="language-rust ro_run noplayground">fn write_key_package&lt;
    HashReference: traits::HashReference&lt;VERSION&gt;,
    KeyPackage: traits::KeyPackage&lt;VERSION&gt;,
&gt;(
    &amp;self,
    hash_ref: &amp;HashReference,
    key_package: &amp;KeyPackage,
) -&gt; Result&lt;(), Self::Error&gt; {
    // Get the validity from the application in some way.
    let validity = self.get_validity(hash_ref);

    // Store the reference and its validity period.
    self.store_hash_ref(hash_ref, validity);

    // Store the actual key package.
    self.store_key_package(hash_ref, key_package);
}</code></pre>
<p>This allows the application to iterate over the hash references and delete outdated
key packages.</p>
<h3 id="openmlsprovider"><a class="header" href="#openmlsprovider">OpenMlsProvider</a></h3>
<p>Additionally, there's a wrapper trait defined that is expected to be passed into
the public OpenMLS API.
Some OpenMLS APIs require only one of the sub-traits, though.</p>
<pre><code class="language-rust no_run noplayground">pub trait OpenMlsProvider {
    type CryptoProvider: crypto::OpenMlsCrypto;
    type RandProvider: random::OpenMlsRand;
    type StorageProvider: storage::StorageProvider&lt;{ storage::CURRENT_VERSION }&gt;;

    // Get the storage provider.
    fn storage(&amp;self) -&gt; &amp;Self::StorageProvider;

    /// Get the crypto provider.
    fn crypto(&amp;self) -&gt; &amp;Self::CryptoProvider;

    /// Get the randomness provider.
    fn rand(&amp;self) -&gt; &amp;Self::RandProvider;
}</code></pre>
<h2 id="implementation-notes"><a class="header" href="#implementation-notes">Implementation Notes</a></h2>
<p>It is not necessary to implement all sub-traits if one functionality is missing.
Suppose you want to use a persisting storage provider. In that case, it is
sufficient to do a new implementation of the <code>StorageProvider</code> trait and
combine it with one of the provided crypto and randomness trait implementations.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../traits/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../traits/types.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../traits/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../traits/types.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
